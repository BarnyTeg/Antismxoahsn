local Players = game:GetService("Players")
local player = Players.LocalPlayer
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- Настройки
local MAX_LOG = 500
local LOG_INTERVAL = 3
local BLACKLIST = {
    "RobloxReplicatedStorage",
    "CoreGui"
}

-- Логирование
local Log = {}
local function addLog(cat, event, data)
    local entry = string.format("[%s][%s] %s: %s",
        os.date("%H:%M:%S"),
        cat,
        event,
        data
    )
    table.insert(Log, 1, entry)
    if #Log > MAX_LOG then table.remove(Log) end
    print(entry)
end

-- Безопасный мониторинг
local function safeHook(obj, callback)
    pcall(function()
        if not obj or not obj.Parent then return end
        for _,v in ipairs(BLACKLIST) do
            if obj:IsDescendantOf(game:GetService(v)) then return end
        end
        callback(obj)
    end)
end

-- 1. Мониторинг инвентаря
local function watchInventory()
    if not player:FindFirstChild("Backpack") then return end
    
    local function logItem(action, item)
        addLog("INVENTORY", action, item.Name.." | "..item.ClassName)
    end

    player.Backpack.ChildAdded:Connect(function(item)
        safeHook(item, function(i) logItem("ADD", i) end)
    end)
    
    player.Backpack.ChildRemoved:Connect(function(item)
        safeHook(item, function(i) logItem("REMOVE", i) end)
    end)
end

-- 2. Мониторинг персонажа
local function watchCharacter()
    player.CharacterAdded:Connect(function(char)
        addLog("CHARACTER", "SPAWN", char.Name)
        
        local humanoid = char:WaitForChild("Humanoid")
        humanoid:GetPropertyChangedSignal("Health"):Connect(function()
            addLog("STATS", "HEALTH", humanoid.Health.."/"..humanoid.MaxHealth)
        end)
    end)
end

-- 3. Мониторинг физики
local function watchPhysics()
    workspace.DescendantAdded:Connect(function(obj)
        safeHook(obj, function(o)
            if o:IsA("BasePart") then
                o.Touched:Connect(function(other)
                    addLog("PHYSICS", "COLLISION", o.Name.." ↔ "..other.Name)
                end)
            end
        end)
    end)
end

-- 4. Мониторинг UI
local function watchUI()
    local function setupButton(btn)
        safeHook(btn, function(b)
            if b:IsA("TextButton") or b:IsA("ImageButton") then
                b.MouseButton1Click:Connect(function()
                    addLog("UI", "CLICK", b:GetFullName())
                end)
            end
        end)
    end

    player:WaitForChild("PlayerGui").DescendantAdded:Connect(setupButton)
    for _,btn in ipairs(player.PlayerGui:GetDescendants()) do
        setupButton(btn)
    end
end

-- 5. Безопасный мониторинг сетевых событий
local function watchNetwork()
    local function logRemote(remote, ...)
        local args = {...}
        local strArgs = ""
        for i,v in ipairs(args) do
            strArgs = strArgs..(i > 1 and ", " or "")..tostring(v)
        end
        addLog("NETWORK", remote.ClassName..": "..remote.Name, 
            "From: "..remote:GetFullName().." | Args: "..strArgs)
    end

    local function hookRemote(remote)
        safeHook(remote, function(r)
            if r:IsA("RemoteEvent") then
                r.OnClientEvent:Connect(function(...)
                    logRemote(r, ...)
                end)
            elseif r:IsA("RemoteFunction") then
                local old = r.InvokeServer
                if old then
                    r.InvokeServer = function(self, ...)
                        logRemote(r, ...)
                        return old(self, ...)
                    end
                end
            end
        end)
    end

    for _,obj in ipairs(game:GetDescendants()) do
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            hookRemote(obj)
        end
    end

    game.DescendantAdded:Connect(function(obj)
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            hookRemote(obj)
        end
    end)
end

-- Запуск
watchInventory()
watchCharacter()
watchPhysics()
watchUI()
watchNetwork()

addLog("SYSTEM", "START", "Logger activated")

-- Автоочистка
while true do
    wait(LOG_INTERVAL)
    if #Log > MAX_LOG * 0.9 then
        for i = MAX_LOG, #Log do
            Log[i] = nil
        end
    end
end
